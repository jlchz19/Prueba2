{% extends "base.html" %}

{% block title %}Producción - AgroGest{% endblock %}
{% block page_title %}Registro de Producción{% endblock %}

{% block content %}
<div class="card">
    <div class="card-header d-flex justify-content-between align-items-center">
        <span>Listado de Producción</span>
        <a href="{{ url_for('nueva_produccion') }}" class="btn btn-primary btn-sm">
            <i class="fas fa-plus me-2"></i>Nueva Producción
        </a>
    </div>
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-hover align-middle">
                <thead>
                    <tr>
                        <th>Animal</th>
                        <th>Tipo</th>
                        <th>Cantidad</th>
                        <th>Fecha</th>
                        <th>Calidad</th>
                        <th class="text-end">Acciones</th>
                    </tr>
                </thead>
                <tbody>
                    {% for produccion in producciones %}
                    <tr>
                        <td>{{ produccion.animal.identificacion }}</td>
                        <td>
                            {% set icons = {'leche': 'fa-fill-drip', 'carne': 'fa-drumstick-bite', 'huevos': 'fa-egg'} %}
                            {% set colors = {'leche': 'info', 'carne': 'warning', 'huevos': 'success'} %}
                            <span class="badge bg-{{ colors.get(produccion.tipo_produccion, 'secondary') }}">
                                <i class="fas {{ icons.get(produccion.tipo_produccion, 'fa-box') }} me-1"></i>
                                {{ produccion.tipo_produccion|title }}
                            </span>
                        </td>
                        <td>{{ produccion.cantidad }} {{ produccion.unidad }}</td>
                        <td>{{ produccion.fecha.strftime('%d/%m/%Y') }}</td>
                        <td>
                            {% set quality_colors = {'excelente': 'success', 'buena': 'info', 'regular': 'warning', 'mala': 'danger'} %}
                            <span class="badge rounded-pill bg-{{ quality_colors.get(produccion.calidad, 'secondary') }}">{{ produccion.calidad|title }}</span>
                        </td>
                        <td class="text-end">
                            <button type="button" class="btn btn-sm btn-outline-secondary" onclick="showProduccionDetails(this)" title="Ver detalles"
                                data-produccion-id="{{ produccion.id }}"
                                data-produccion-animal="{{ produccion.animal.identificacion }}"
                                data-produccion-tipo="{{ produccion.tipo_produccion }}"
                                data-produccion-cantidad="{{ produccion.cantidad }}"
                                data-produccion-unidad="{{ produccion.unidad }}"
                                data-produccion-fecha="{{ produccion.fecha.strftime('%d/%m/%Y') }}"
                                data-produccion-calidad="{{ produccion.calidad }}">
                                <i class="fas fa-eye"></i>
                            </button>
                            <a href="{{ url_for('editar_produccion', produccion_id=produccion.id) }}" class="btn btn-sm btn-outline-primary ms-1" title="Editar">
                                <i class="fas fa-edit"></i>
                            </a>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        
        {% if not producciones %}
        <div class="text-center py-5">
            <i class="fas fa-chart-bar fa-4x text-muted mb-3"></i>
            <h5 class="text-muted mb-3">No hay registros de producción</h5>
            <p>Comienza a medir el rendimiento de tu finca.</p>
            <a href="{{ url_for('nueva_produccion') }}" class="btn btn-primary mt-2">
                <i class="fas fa-plus me-2"></i>Registrar Producción
            </a>
        </div>
        {% endif %}
    </div>
</div>

<!-- Modal personalizado para detalles de producción -->
<div id="produccionDetailsModal" class="custom-modal" style="display: none;" role="dialog" aria-modal="true" aria-labelledby="modalProduccionTitle">
    <div class="modal-overlay" onclick="closeProduccionModal()"></div>
    <div class="modal-container">
        <div class="modal-header">
            <h5 id="modalProduccionTitle" class="modal-title"></h5>
            <button type="button" class="modal-close" onclick="closeProduccionModal()">&times;</button>
        </div>
        <div class="modal-body">
            <div class="row">
                <div class="col-md-6">
                    <div class="info-card">
                        <h6 class="info-title">Información del Animal</h6>
                        <div class="info-item">
                            <span class="info-label">Animal:</span>
                            <span id="modalProduccionAnimal" class="info-value"></span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Tipo de Producción:</span>
                            <span id="modalProduccionTipo" class="info-value"></span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Fecha:</span>
                            <span id="modalProduccionFecha" class="info-value"></span>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="info-card">
                        <h6 class="info-title">Detalles de Producción</h6>
                        <div class="info-item">
                            <span class="info-label">Cantidad:</span>
                            <span id="modalProduccionCantidad" class="info-value"></span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Unidad:</span>
                            <span id="modalProduccionUnidad" class="info-value"></span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Calidad:</span>
                            <span id="modalProduccionCalidad" class="info-value"></span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-secondary" onclick="closeProduccionModal()">Cerrar</button>
        </div>
    </div>
</div>

<style>
.custom-modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    z-index: 2000; /* por encima de navbar/sidebar */
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 16px; /* ayuda a centrar con espacio en bordes */
    visibility: visible;
    opacity: 1;
    pointer-events: auto;
}

.modal-overlay {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.5);
    backdrop-filter: blur(2px);
    z-index: 1;
    opacity: 1;
}

.modal-container {
    position: relative;
    background: white;
    border-radius: 12px;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
    max-width: 600px;
    width: 90%;
    max-height: 90vh; /* un poco más alto y centrado */
    overflow-y: auto;
    animation: slideIn 0.3s ease-out;
    margin: 0 auto; /* asegurar centrado horizontal */
    z-index: 2;
    opacity: 1;
}

@keyframes slideIn {
    from {
        opacity: 0;
        transform: translateY(-50px) scale(0.9);
    }
    to {
        opacity: 1;
        transform: translateY(0) scale(1);
    }
}

.modal-header {
    padding: 20px;
    border-bottom: 1px solid #e9ecef;
    display: flex;
    justify-content: space-between;
    align-items: center;
    background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
    color: white;
    border-radius: 12px 12px 0 0;
}

.modal-title {
    margin: 0;
    font-size: 1.25rem;
    font-weight: 600;
    color: white;
}

.modal-close {
    background: none;
    border: none;
    font-size: 24px;
    color: white;
    cursor: pointer;
    padding: 0;
    width: 30px;
    height: 30px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 50%;
    transition: background-color 0.2s;
}

.modal-close:hover {
    background-color: rgba(255, 255, 255, 0.2);
}

.modal-body {
    padding: 20px;
}

.info-card {
    background: #f8f9fa;
    border-radius: 8px;
    padding: 15px;
    margin-bottom: 15px;
    border-left: 4px solid #28a745;
}

.info-title {
    color: #495057;
    font-weight: 600;
    margin-bottom: 12px;
    font-size: 0.95rem;
}

.info-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 8px 0;
    border-bottom: 1px solid #e9ecef;
}

.info-item:last-child {
    border-bottom: none;
}

.info-label {
    font-weight: 500;
    color: #6c757d;
    font-size: 0.9rem;
}

.info-value {
    font-weight: 600;
    color: #212529;
    text-align: right;
}

.modal-footer {
    padding: 15px 20px;
    border-top: 1px solid #e9ecef;
    display: flex;
    justify-content: flex-end;
    gap: 10px;
    background: #f8f9fa;
    border-radius: 0 0 12px 12px;
}
</style>

<script>
function showProduccionDetails(el) {
    const btnEl = (el && typeof el.closest === 'function') ? el.closest('button') : null;
    const data = (btnEl && btnEl.dataset) ? btnEl.dataset : {};
    
    // Llenar los datos del modal
    const setText = (id, value, fallback='') => {
        const node = document.getElementById(id);
        if (node) node.textContent = (value != null ? value : fallback);
    };
    const titleNode = document.getElementById('modalProduccionTitle');
    if (titleNode) titleNode.innerHTML = '<i class="fas fa-chart-bar me-2"></i>Detalles de Producción';
    setText('modalProduccionAnimal', data.produccionAnimal, '-');
    setText('modalProduccionTipo', data.produccionTipo, '-');
    setText('modalProduccionCantidad', data.produccionCantidad, '-');
    setText('modalProduccionUnidad', data.produccionUnidad, '-');
    setText('modalProduccionFecha', data.produccionFecha, '-');
    setText('modalProduccionCalidad', data.produccionCalidad, '-');
    
    // Mostrar el modal
    const modal = document.getElementById('produccionDetailsModal');
    // Asegurar que el modal esté directamente bajo body para evitar problemas de apilamiento/overflow
    if (modal && modal.parentNode !== document.body) {
        try { document.body.appendChild(modal); } catch(e) {}
    }
    if (modal) {
        modal.style.display = 'flex';
        modal.style.visibility = 'visible';
        modal.style.opacity = '1';
        modal.style.pointerEvents = 'auto';
        const overlay = modal.querySelector('.modal-overlay');
        const container = modal.querySelector('.modal-container');
        if (overlay) overlay.style.opacity = '1';
        if (container) container.style.opacity = '1';
        // Forzar reflow y repintado para asegurar visibilidad inmediata
        void modal.offsetHeight;
        requestAnimationFrame(() => {
            modal.style.transform = 'translateZ(0)';
        });
    }
    if (document && document.body) document.body.style.overflow = 'hidden';
    // Asegurar que el viewport esté arriba para ver el modal centrado
    try { window.scrollTo({ top: 0, behavior: 'instant' }); } catch(e) { window.scrollTo(0,0); }
    // Llevar el scroll interno del modal al inicio
    const container = modal ? modal.querySelector('.modal-container') : null;
    if (container) container.scrollTop = 0;
}

function closeProduccionModal() {
    const modal = document.getElementById('produccionDetailsModal');
    if (modal) {
        modal.style.display = 'none';
        modal.style.visibility = 'hidden';
        modal.style.opacity = '0';
        modal.style.pointerEvents = 'none';
    }
    if (document && document.body) document.body.style.overflow = 'auto';
}

// Cerrar modal con ESC
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        closeProduccionModal();
    }
});
</script>
{% endblock %}